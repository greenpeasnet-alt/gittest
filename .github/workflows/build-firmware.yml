name: Build PlatformIO Firmware (ESP32-S3 Waveshare)

on:
  push:
    branches: [ main, master, develop ]     # możesz zmienić na inne branche
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:                        # pozwala uruchomić ręcznie z GitHub UI

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Pobierz kod repozytorium
        uses: actions/checkout@v4
        with:
          submodules: recursive               # na wszelki wypadek jeśli masz biblioteki z gita

      - name: Cache PlatformIO (przyspiesza kolejne buildy)
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-platformio-${{ hashFiles('platformio.ini') }}
          restore-keys: ${{ runner.os }}-platformio-

      - name: Zainstaluj Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Zainstaluj PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Buduj firmware (tylko Twój env)
        run: pio run -e waveshare_esp32s3_rs485_can

      - name: Zapisz firmware jako artifact (do pobrania)
        uses: actions/upload-artifact@v4
        with:
          name: firmware-waveshare-esp32s3
          path: .pio/build/waveshare_esp32s3_rs485_can/firmware.bin
          if-no-files-found: error
          compression-level: 6
          retention-days: 14                  # pliki zostają 14 dni